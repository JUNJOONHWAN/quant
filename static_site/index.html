<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>시장 안정성 대시보드</title>
  <link rel="stylesheet" href="./assets/styles.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script defer src="./assets/metrics.js"></script>
  <script defer src="./assets/app.js"></script>
</head>
<body>
  <div id="data-info" class="notice hidden" role="status"></div>
  <header>
    <h1>시장 안정성 지수</h1>
    <p class="subtitle">자산 상관관계를 활용한 일별 시장 안정성 모니터링</p>
    <div class="update-info">
      <span id="last-updated"></span>
      <span id="generated-at"></span>
    </div>
  </header>
  <div id="error-box" class="error hidden"></div>
  <section class="controls">
    <label>
      윈도우
      <select id="window-select"></select>
    </label>
    <label>
      표시 기간
      <select id="range-select">
        <option value="30">30일</option>
        <option value="60">60일</option>
        <option value="90">90일</option>
        <option value="180">180일</option>
      </select>
    </label>
    <label>
      맞춤 시작일
      <input type="date" id="custom-start" />
    </label>
    <label>
      맞춤 종료일
      <input type="date" id="custom-end" />
    </label>
    <label>
      자산 쌍
      <select id="pair-select"></select>
    </label>
    <label>
      레짐 모드
      <select id="risk-mode">
        <option value="classic">Classic</option>
        <option value="enhanced">Enhanced</option>
      </select>
    </label>
    <button type="button" id="refresh-button" class="refresh-button">리프레시</button>
    <p id="custom-range-feedback" class="controls-helper"></p>
  </section>
  <main>
    <section class="panel" id="risk-panel">
      <div class="panel-header">
        <h2>리스크 레짐</h2>
        <button type="button" class="info" data-target="info-risk">ⓘ</button>
      </div>
      <div id="regime-alerts" class="alerts"></div>
      <div class="sub-gauges">
        <div class="sub-gauge">
          <h3>Risk-on 점수</h3>
          <div id="risk-score-gauge" class="chart"></div>
        </div>
        <div class="sub-gauge">
          <h3>레짐 타임라인</h3>
          <div id="risk-timeline" class="chart risk-timeline"></div>
        </div>
      </div>
    </section>
    <section class="panel" id="backtest-panel">
      <div class="panel-header">
        <h2>레짐 백테스트</h2>
        <button type="button" class="info" data-target="info-backtest">ⓘ</button>
      </div>
      <div id="backtest-chart" class="chart"></div>
      <p id="backtest-stats" class="controls-helper"></p>
    </section>
    <section class="panel" id="gauge-panel">
      <div class="panel-header">
        <h2>시장 안정성 게이지</h2>
        <button type="button" class="info" data-target="info-stability">ⓘ</button>
      </div>
      <div id="stability-gauge" class="chart"></div>
      <ul class="legend">
        <li><span class="legend-box red"></span>불안정 (0.0 - 0.3)</li>
        <li><span class="legend-box yellow"></span>중립 (0.3 - 0.4)</li>
        <li><span class="legend-box green"></span>안정 (0.4 - 1.0)</li>
      </ul>
    </section>

    <section class="panel" id="subgauges-panel">
      <div class="panel-header">
        <h2>하위 지수</h2>
        <button type="button" class="info" data-target="info-sub">ⓘ</button>
      </div>
      <div class="sub-gauges">
        <div class="sub-gauge">
          <h3>주식-암호화폐</h3>
          <div id="stock-crypto-gauge" class="chart"></div>
        </div>
        <div class="sub-gauge">
          <h3>전통자산</h3>
          <div id="traditional-gauge" class="chart"></div>
        </div>
        <div class="sub-gauge">
          <h3>안전자산 결합력</h3>
          <div id="safe-neg-gauge" class="chart"></div>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h2>지수 추이</h2>
      </div>
      <div id="history-chart" class="chart"></div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h2>자산 상관관계 히트맵</h2>
      </div>
      <div id="heatmap-chart" class="chart"></div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h2>자산 쌍 상세</h2>
        <button type="button" class="info" data-target="info-pair">ⓘ</button>
      </div>
      <div class="pair-charts">
        <div class="pair-chart-block">
          <h3>가격 비교</h3>
          <div id="pair-price-chart" class="chart"></div>
        </div>
        <div class="pair-chart-block">
          <h3>상관도 &amp; 기준 자산</h3>
          <div id="pair-correlation-chart" class="chart"></div>
        </div>
      </div>
    </section>
  </main>

  <section class="info-popover" id="info-stability">
    <button type="button" class="popover-close" aria-label="닫기">×</button>
    <h3>시장 안정성 지수</h3>
    <p>
      정의: 자산 간 상관계수의 절댓값을 가중 평균(주식–채권 가중↑)한 값입니다. 0은 분산(비동행), 1은 완전 동행을 의미합니다.
    </p>
    <p>
      해석: 위기 구간에서 상관이 전반적으로 상승하는 경향(“상관이 1로 수렴”)이 있습니다. 절댓값 상관이 높고 첫 고유값(시장 모드) 지배가 커질수록
      분산 효과가 약해져 ‘Risk-Off’ 환경에 가까워집니다.
    </p>
    <p>
      눈금: 빨강(0–0.3), 노랑(0.3–0.4), 초록(0.4–1.0)은 동일 구간 대비 상대적 해석을 돕는 범례입니다.
    </p>
  </section>
  <section class="info-popover" id="info-sub">
    <button type="button" class="popover-close" aria-label="닫기">×</button>
    <h3>하위 지수 설명</h3>
    <ul>
      <li><strong>주식-암호화폐</strong>: IWM/SPY와 BTC 간 절댓값 상관계수 평균.</li>
      <li><strong>전통자산</strong>: IWM, SPY, TLT, GLD 간 절댓값 상관계수 평균.</li>
      <li><strong>안전자산 결합력</strong>: 주식과 (TLT, GLD) 조합의 음의 상관관계를 0 이상으로 환산해 평균.</li>
    </ul>
  </section>
  <section class="info-popover" id="info-risk">
    <button type="button" class="popover-close" aria-label="닫기">×</button>
    <h3>리스크 레짐 산출</h3>
    <p>
      Classic 모드: IWM–BTC 30일 롤링 상관(0.35 이상 가점, 0.50 이상 즉시 Risk‑On)과 안전·위험 자산 간 역상관(Safe‑NEG)을 조합한 단순 점수입니다. 상관이 −0.10 이하이거나 점수가 0.30 이하이면 Risk‑Off, 0.60 이상이면 Risk‑On, 그 외는 Neutral입니다.
    </p>
    <p>
      Enhanced 모드: Classic 점수에 (1) IWM·BTC 10일 공동 모멘텀, (2) IWM·SPY·BTC 5일 상승비중(리스크 폭), (3) 흡수비·Safe‑NEG·안정성 기울기를 묶은 “위험 가드”를 추가합니다. Risk‑On은 점수 ≥0.63·상관 ≥0.35·모멘텀 필터 통과·위험가드 &lt; 0.9일 때만 허용되며, 위험가드가 0.8~0.9이면 Fragile로 표기합니다. 위험가드 ≥1, Safe‑NEG ≥0.6, 공동 모멘텀 ≤ −3% 중 하나라도 만족하면 Risk‑Off로 강등됩니다.
    </p>
    <p>
      해석: 흡수비(시장 모드 집중도)가 높거나 안전자산으로의 강한 수급이 관측되면 상관이 높아도 “군집형” 랠리로 판단하여 레짐을 늦추고, 두 자산이 동시에 하락하는 고상관 구간은 즉시 Risk‑Off로 분류합니다.
    </p>
  </section>
  <section class="info-popover" id="info-backtest">
    <button type="button" class="popover-close" aria-label="닫기">×</button>
    <h3>레짐 백테스트</h3>
    <p>전략: Risk‑On일 때만 기준 자산(기본 QQQ, On 구간은 TQQQ 3배 추정)을 보유하고, 그 외에는 현금(0%)으로 가정합니다. 벤치마크는 동일 자산의 장기 보유입니다.</p>
    <p>지표: 누적 수익, 히트레이트(다음날·5일 수익 방향 적중률), 최대낙폭 등. 임계치는 과거 분포로 보정하는 것을 권장합니다.</p>
  </section>
  <section class="info-popover" id="info-pair">
    <button type="button" class="popover-close" aria-label="닫기">×</button>
    <h3>자산 쌍 상세</h3>
    <p>상단 그래프는 선택한 두 자산의 일별 가격을 좌·우축으로 비교합니다. 하단 그래프는 롤링 상관계수(좌측 축)와 첫 번째 자산의 가격(우측 축) 추이를 함께 보여줍니다.</p>
  </section>

  <footer>
    <p>데이터 출처: Alpha Vantage 일별 엔드포인트(비상업적 이용). 투자 조언이 아니며 정확성을 보장하지 않습니다.</p>
  </footer>

</body>
</html>
