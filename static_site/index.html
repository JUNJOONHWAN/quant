<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>시장 안정성 대시보드</title>
  <link rel="stylesheet" href="./assets/styles.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script defer src="./assets/metrics.js"></script>
  <script defer src="./assets/app.js"></script>
</head>
<body>
  <div id="data-info" class="notice hidden" role="status"></div>
  <header>
    <h1>자산 결합 강도 (시장 안정성 지수)</h1>
    <p class="subtitle">자산 상관관계를 활용한 일별 시장 안정성 모니터링</p>
    <div class="update-info">
      <span id="last-updated"></span>
      <span id="generated-at"></span>
    </div>
  </header>
  <div id="error-box" class="error hidden"></div>
  <section class="controls">
    <label>
      윈도우
      <select id="window-select"></select>
    </label>
    <label>
      표시 기간
      <select id="range-select">
        <option value="30">30일</option>
        <option value="60">60일</option>
        <option value="90">90일</option>
        <option value="180">180일</option>
      </select>
    </label>
    <label>
      맞춤 시작일
      <input type="date" id="custom-start" />
    </label>
    <label>
      맞춤 종료일
      <input type="date" id="custom-end" />
    </label>
    <label>
      자산 쌍
      <select id="pair-select"></select>
    </label>
    <label>
      레짐 모드
      <select id="risk-mode">
        <option value="classic">Classic</option>
        <option value="enhanced">Enhanced</option>
      </select>
    </label>
    <button type="button" id="refresh-button" class="refresh-button">리프레시</button>
    <button type="button" id="download-report" class="button-secondary">TXT 리포트</button>
    <p id="custom-range-feedback" class="controls-helper"></p>
  </section>
  <main>
    <section class="panel" id="risk-panel">
      <div class="panel-header">
        <h2>리스크 레짐</h2>
        <button type="button" class="info" data-target="info-risk">ⓘ</button>
      </div>
      <p class="panel-context">Risk-On 지표는 결합 강도 신호에 모멘텀·Safe-NEG·Guard(흡수비, 안정성 델타)를 겹겹이 적용해 “지금 공격/방어 포지션을 취할지”를 판단합니다. 결합 강도만으로는 On/Off가 결정되지 않습니다.</p>
      <div id="regime-alerts" class="alerts"></div>
      <div class="sub-gauges">
        <div class="sub-gauge">
          <h3>Risk-on 점수</h3>
          <div id="risk-score-gauge" class="chart"></div>
        </div>
        <div class="sub-gauge">
          <h3>레짐 타임라인</h3>
          <div id="risk-timeline" class="chart risk-timeline"></div>
        </div>
      </div>
      <!-- FFL extra gauges (only populated when risk-mode=ffl) -->
      <div class="sub-gauges">
        <div class="sub-gauge">
          <h3>FFL 플럭스 (J_norm)</h3>
          <div id="ffl-flux-gauge" class="chart"></div>
        </div>
        <div class="sub-gauge">
          <h3>FFL 강도 (FINT)</h3>
          <div id="ffl-fint-gauge" class="chart"></div>
        </div>
      </div>
    </section>
    <section class="panel" id="gauge-panel">
      <div class="panel-header">
        <h2>자산 결합 강도</h2>
        <button type="button" class="info" data-target="info-stability">ⓘ</button>
      </div>
      <p class="panel-context">결합 강도는 시장 동조화 정도(맥락 지표)만 알려주며, 실제 Risk-On/Off 결정은 아래 레짐 점수가 담당합니다. 값이 높다면 자금이 한 방향으로 쏠렸다는 뜻이니 Guard·히트맵과 함께 해석하세요.</p>
      <div id="stability-gauge" class="chart"></div>
      <ul class="legend">
        <li><span class="legend-box red"></span>분산/결합 약함 (0.0 - 0.3)</li>
        <li><span class="legend-box yellow"></span>과도기 (0.3 - 0.4)</li>
        <li><span class="legend-box green"></span>동조/결합 강함 (0.4 - 1.0)</li>
      </ul>
    </section>

    <section class="panel" id="subgauges-panel">
      <div class="panel-header">
        <h2>하위 지수</h2>
        <button type="button" class="info" data-target="info-sub">ⓘ</button>
      </div>
      <div class="sub-gauges">
        <div class="sub-gauge">
          <h3>주식-암호화폐 (+)</h3>
          <div id="stock-crypto-gauge" class="chart"></div>
        </div>
        <div class="sub-gauge">
          <h3>전통자산 (+)</h3>
          <div id="traditional-gauge" class="chart"></div>
        </div>
        <div class="sub-gauge">
          <h3>안전자산 결합력 (-)</h3>
          <div id="safe-neg-gauge" class="chart"></div>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h2>지수 추이</h2>
      </div>
      <div id="history-chart" class="chart"></div>
    </section>

    <section class="panel" id="backtest-panel">
      <div class="panel-header">
        <h2>레짐 백테스트</h2>
        <button type="button" class="info" data-target="info-backtest">ⓘ</button>
      </div>
      <div id="backtest-chart" class="chart"></div>
      <p id="backtest-stats" class="controls-helper"></p>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h2>자산 상관관계 히트맵</h2>
        <button type="button" class="info" data-target="info-heatmap">ⓘ</button>
      </div>
      <div id="heatmap-chart" class="chart"></div>
      <div class="heatmap-slider">
        <label for="heatmap-slider">일자 선택</label>
        <input type="range" id="heatmap-slider" min="0" max="0" value="0" />
        <span id="heatmap-slider-label">-</span>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h2>자산 쌍 상세</h2>
        <button type="button" class="info" data-target="info-pair">ⓘ</button>
      </div>
      <div class="pair-charts">
        <div class="pair-chart-block">
          <h3>가격 비교</h3>
          <div id="pair-price-chart" class="chart"></div>
        </div>
        <div class="pair-chart-block">
          <h3>상관도 &amp; 기준 자산</h3>
          <div id="pair-correlation-chart" class="chart"></div>
        </div>
      </div>
    </section>

    <section class="panel insights-panel">
      <div class="panel-header">
        <h2>상관 구조 인사이트</h2>
      </div>
      <p>
        2017~2023년에는 비트코인이 주로 “디지털 금/유동성 지표”처럼 움직였습니다. 금리 급등·달러 강세 구간에서는 BTC가 방어적으로 움직이고,
        IWM·QQQ는 실적·성장 기대에 따라 별도로 움직여 상관계수가 0 혹은 음수로 떨어졌습니다. 이때는 Classic 모델이 corr 하락을 Risk-Off로 읽었지만,
        실제 주식은 리오프닝·실적 모멘텀으로 상승하는 ‘역상관 랠리’가 자주 나타났습니다.
      </p>
      <p>
        2024년 이후에는 현물 ETF 승인, AI/성장 테마 확산으로 비트코인이 <strong>성장주 베타</strong>와 거의 같은 속도로 움직입니다. IWM·SPY와의 상관이
        0.5 이상으로 붙으면 Classic/Enhanced 모두 즉시 Risk-On을 내고, 히트맵도 “동조화된 위험랠리”를 포착합니다. 즉, 코인이 주식 자금과 동시에 흘러들어오는지를
        관찰하면 위험선호가 “방향성을 가진 랠리”인지, 혹은 “유동성만 빠지는 방어 구간”인지 빠르게 구분할 수 있습니다.
      </p>
      <p>
        요약하면, <em>코인이 디지털 금 모드</em>일 땐 corr 하락=방어 신호, <em>성장 베타 모드</em>일 땐 corr 상승=공격 신호입니다. 히트맵+레짐 토글(IWM↔QQQ)을
        함께 보면서 현재 시장이 어느 모드에 있는지 판단하면 지표의 가치를 극대화할 수 있습니다.
      </p>
    </section>
  </main>

  <section class="info-popover" id="info-stability">
    <button type="button" class="popover-close" aria-label="닫기">×</button>
    <h3>자산 결합 강도 (Stability Index)</h3>
    <p>
      정의: IWM·SPY·TLT·GLD·BTC 간 상관계수의 절댓값을 주식/채권 가중으로 묶은 0~1 지수로, 다섯 자산이 얼마나 강하게 결합되어 움직이는지 보여줍니다. 0은 흩어진 움직임, 1은 완전 동조입니다.
    </p>
    <p>
      활용: <strong>0.40 이상 + 단기 모멘텀 ▲</strong>이면 ‘광범위 Risk-On(결합 강도 상승 속 상승)’이고, <strong>0.40 이상 + 모멘텀 ▼</strong>이면 ‘안정된 하락(결합 강하지만 가격 하락)’이므로 Guard·히트맵을 함께 봅니다. 2025-10-13 이후처럼 값이 급등했는데도 레짐이 Risk-Off라면 “방향성 미확인” 단계이니 Guard·모멘텀·히트맵을 병행 확인하세요.
    </p>
    <p>
      색상: 빨강(0–0.3)은 분산/결합 약함, 노랑(0.3–0.4)은 동조 전환 구간, 초록(0.4–1.0)은 결합 강함(위험/기회 집중)입니다. 초록이어도 흡수비(mm) ≥ 0.90이면 Guard가 긴장 상태일 수 있습니다.
    </p>
  </section>
  <section class="info-popover" id="info-sub">
    <button type="button" class="popover-close" aria-label="닫기">×</button>
    <h3>하위 지수 설명</h3>
    <ul>
      <li><strong>주식-암호화폐 (+)</strong>: IWM·SPY 대비 BTC 절댓값 상관. 0.5 이상이면 소형주·크립토 랠리가 동시 진행되는 구간(예: 1/10~1/24, 10/24)이라 Classic 점수가 급등합니다.</li>
      <li><strong>전통자산 (+)</strong>: IWM·SPY·TLT·GLD 내부 상관. 0.6 이상으로 뭉치면 “금리/실적 이벤트” 영향이 커졌다는 뜻이니 흡수비와 함께 Guard를 확인해 False Risk-On을 걸러냅니다.</li>
      <li><strong>안전자산 결합력 (-)</strong>: 주식 ↔ (TLT, GLD) 음의 상관을 0~1로 환산. 0.6 이상이면 안전자산 약세 → 위험선호로 읽지만, 금리 쇼크처럼 주식도 함께 하락하면 오히려 경고 신호일 수 있으니 반드시 모멘텀을 함께 봅니다.</li>
    </ul>
  </section>
  <section class="info-popover" id="info-risk">
    <button type="button" class="popover-close" aria-label="닫기">×</button>
    <h3>리스크 레짐 산출</h3>
    <p>
      Classic: IWM–BTC 30일 상관 70%와 Safe‑NEG 30%를 조합한 점수입니다. corr ≥ 0.50 또는 점수 ≥ 0.65면 Risk‑On, corr ≤ −0.05 또는 점수 ≤ 0.30이면 Risk‑Off입니다. 두 자산이 모두 하락하는 고상관 구간은 Safe‑NEG와 Score 조건을 통과하지 않으면 On으로 전환하지 않습니다.
    </p>
    <p>
      Enhanced: Classic 점수에 10일 공동 모멘텀, IWM·SPY·BTC 5일 리스크 폭, 흡수비/안정성 기반 guardScore를 더해 “확신된” On만 통과시킵니다. blended ≥ 0.60, corr ≥ 0.33, momentum ≥ 0.35, guard &lt; 0.9, combo > −0.5%를 동시에 만족해야 합니다.
    </p>
    <p>
      FFL(Classic+Flux): Safe↔Risk 플럭스(J_norm)·FINT·FAR·Guard를 Classic 위에 얹은 변형입니다. On은 mm(흡수비) 수준에 따라 J_norm 문턱을 상향 적용하고(고상관일수록 보수화) Guard &lt; 0.95 및 폭 조건을 만족하거나, RB_Flux ≥ 0.06 &amp; Combo ≥ +0.10이면 대안 경로로 허용합니다. Off는 J_norm이 동적 Off 문턱 이하이거나 Absorption ≥ 0.98일 때이며, Guard/Absorption만으로 발생하는 Off는 2일(고상관·상승 환경은 3일) 연속 확인 후 확정합니다. 기본 모드는 Classic입니다.
    </p>
    <p>
      활용 팁: <strong>강력 Risk-On</strong>은 (1) corr ≥ 0.5, (2) comboMomentum ≥ +1.5%, (3) guard < 0.7이 동시에 잡힐 때이며 2025-10-24가 대표 사례입니다. 스태빌리티·상관이 높아도 guard ≥ 0.9 또는 combo ≤ 0%라면 “안정된 하락”으로 보고 On 진입을 유보하세요.
    </p>
  </section>
  <section class="info-popover" id="info-backtest">
    <button type="button" class="popover-close" aria-label="닫기">×</button>
    <h3>레짐 백테스트</h3>
    <p>전략: 신호는 IWM·SPY·TLT·GLD·BTC에서 만들지만, 트레이드는 QQQ 계열로 평가합니다. Risk‑On=레버리지 ETF(TNA/TQQQ 등), Neutral=기준 ETF(IWM/QQQ), Off=현금(0%). 체결은 1일 지연을 가정합니다.</p>
    <p>읽는 법: 배경 색 띠는 레짐(온·오프·뉴트럴)과 동기화됩니다. 히트율(1일/5일)은 “레짐과 같은 방향으로 수익이 났는가”를 뜻하며 60% 이상이면 모멘텀을 잘 포착한 것입니다. Guard가 높아 On 진입을 건너뛰면 벤치마크 대비 언더퍼폼 구간이 생기므로 파라미터 재점검 포인트로 활용하세요.</p>
  </section>
  <section class="info-popover" id="info-pair">
    <button type="button" class="popover-close" aria-label="닫기">×</button>
    <h3>자산 쌍 상세</h3>
    <p>상단 그래프는 선택한 두 자산의 일별 가격을 좌·우축으로 비교합니다. 하단 그래프는 롤링 상관계수(좌측 축)와 첫 번째 자산의 가격(우측 축)을 겹쳐 “가격 급락 + 상관 급등” 같은 Classic 민감 구간을 복기할 수 있도록 했습니다.</p>
    <p>팁: IWM|BTC 상관이 0.5 근처인데 가격이 동시에 하락하면 Safe‑NEG·모멘텀이 방어 역할을 하는지 확인하세요. 반대로 가격·상관이 동시에 상승하고 흡수비가 0.8 미만이면 10/24처럼 강한 Risk‑On 후보일 수 있습니다.</p>
  </section>
  <section class="info-popover" id="info-heatmap">
    <button type="button" class="popover-close" aria-label="닫기">×</button>
    <h3>상관 히트맵 &amp; 슬라이더</h3>
    <p>
      색상은 −1(청록)~+1(빨강)로 정규화됩니다. 2~3월처럼 전 종목이 빨갛게 채워지면 “모든 자산이 한 요인에 묶인” 구간으로, 스태빌리티·흡수비도 함께 치솟아 Guard가 Risk-Off를 고집할 수 있습니다.
    </p>
    <p>
      하단 슬라이더는 동일 창(window) 내 일자들을 순회합니다. 연속으로 빨강이 이어지는데 모멘텀·Guard가 풀리지 않으면 ‘안정된 하락’일 가능성이 높고, 빨강 속에서 BTC 행/열만 먼저 파랗게 풀리면 소형주 대비 크립토 디커플링 신호입니다.
    </p>
    <p>
      팁: 히트맵이 초록/청록으로 분산되기 시작하면 레짐 전환 후보이므로 같은 날짜의 레짐 타임라인·백테스트 위치를 눌러 가격곡선 변곡과 연결해서 보세요.
    </p>
  </section>

  <footer>
    <p>데이터 출처: Alpha Vantage 일별 엔드포인트(비상업적 이용). 투자 조언이 아니며 정확성을 보장하지 않습니다.</p>
  </footer>

</body>
</html>
